<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق فواتير الدليفري</title>
    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDoc, getDocs, query, doc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            getFirestore,
            collection,
            addDoc,
            getDoc,
            getDocs,
            query,
            doc,
            runTransaction
        };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Changa:wght@700&family=Almarai:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Almarai', sans-serif;
        }
        .invoice-print-container {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            font-family: 'Almarai', sans-serif;
            direction: rtl;
        }
        .invoice-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 15px; margin-bottom: 15px; }
        .invoice-header h2 { margin: 0; font-size: 1.5em; font-family: 'Changa', sans-serif; }
        .invoice-header p { margin: 0; font-size: 1em; font-weight: bold; }
        .invoice-details p { margin: 3px 0; font-weight: bold; }
        .invoice-details { border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
        .invoice-items { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .invoice-items th, .invoice-items td { padding: 8px; text-align: right; font-weight: bold; }
        .invoice-items th { border-bottom: 1px solid #000; }
        .invoice-totals { text-align: right; border-top: 2px dashed #000; padding-top: 10px; }
        .invoice-totals div { display: flex; justify-content: space-between; margin-bottom: 3px; font-weight: bold; }
        .invoice-footer { text-align: center; margin-top: 15px; font-size: 0.8em; }
    </style>
</head>
<body dir="rtl" class="bg-red-600">
    <div id="root"></div>

    <script type="text/babel">
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Destructure Firebase methods from the global window object
        const { initializeApp, getAuth, signInAnonymously, getFirestore, collection, addDoc, getDoc, getDocs, query, doc, runTransaction } = window.firebase;

        const { useState, useEffect, useRef, useCallback } = React;

        const App = () => {
            const [currentPage, setCurrentPage] = useState('invoice');
            const [branchName, setBranchName] = useState('');
            const [cashierName, setCashierName] = useState('');
            const [deliveryName, setDeliveryName] = useState('');
            const [customerName, setCustomerName] = useState('');
            const [customerPhone, setCustomerPhone] = useState('');
            const [orderNumber, setOrderNumber] = useState('');
            const [orderDate, setOrderDate] = useState(new Date().toISOString().slice(0, 16));
            const [items, setItems] = useState([{ id: 1, name: '', quantity: 1, price: '' }]);
            const [total, setTotal] = useState(0);
            const [statusMessage, setStatusMessage] = useState({ message: '', type: '' });
            const [isDbReady, setIsDbReady] = useState(false);
            const [salesData, setSalesData] = useState([]);
            const [showSavedOrders, setShowSavedOrders] = useState(false);
            const [isLoadingOrderNumber, setIsLoadingOrderNumber] = useState(true);
            const [isOrderSaved, setIsOrderSaved] = useState(false);
            const [sharedInvoiceId, setSharedInvoiceId] = useState(null);
            
            const dbRef = useRef(null);
            const authRef = useRef(null);
            const userIdRef = useRef(null);
            
            const displayStatus = (message, type) => {
                setStatusMessage({ message, type });
                setTimeout(() => setStatusMessage({ message: '', type: '' }), 3000);
            };

            const fetchAndIncrementOrderNumber = useCallback(async () => {
                // If Firebase is not ready (e.g., saved as a local HTML file), provide a fallback.
                if (!dbRef.current || !userIdRef.current) {
                    setOrderNumber(Date.now().toString());
                    setIsLoadingOrderNumber(false);
                    return;
                }

                const counterRef = doc(dbRef.current, `/artifacts/${appId}/users/${userIdRef.current}/counters/order_number`);
                setIsLoadingOrderNumber(true);
                let newOrderNumber = null;

                try {
                    await runTransaction(dbRef.current, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        const currentNumber = counterDoc.exists() ? counterDoc.data().currentNumber : 0;
                        newOrderNumber = currentNumber + 1;
                        transaction.set(counterRef, { currentNumber: newOrderNumber });
                    });
                    setOrderNumber(newOrderNumber.toString());
                } catch (error) {
                    console.error("Error in transaction for order number:", error);
                    displayStatus('حدث خطأ في جلب رقم الطلب. يرجى المحاولة مرة أخرى.', 'error');
                } finally {
                    setIsLoadingOrderNumber(false);
                }
            }, [appId]);

            const resetForm = useCallback(() => {
                setBranchName('');
                setCashierName('');
                setDeliveryName('');
                setCustomerName('');
                setCustomerPhone('');
                setOrderDate(new Date().toISOString().slice(0, 16));
                setItems([{ id: 1, name: '', quantity: 1, price: '' }]);
                setTotal(0);
                setIsOrderSaved(false);
                setSharedInvoiceId(null);
                fetchAndIncrementOrderNumber();
            }, [fetchAndIncrementOrderNumber]);
            
            // Initial Firebase and data fetch effect
            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        if (Object.keys(firebaseConfig).length === 0) {
                            displayStatus('إعدادات Firebase غير متوفرة. لا يمكن حفظ البيانات.', 'error');
                            // Fallback for local usage
                            setIsDbReady(false);
                            fetchAndIncrementOrderNumber();
                            return;
                        }
                        const app = initializeApp(firebaseConfig);
                        authRef.current = getAuth(app);
                        dbRef.current = getFirestore(app);
                        
                        await signInAnonymously(authRef.current);
                        
                        userIdRef.current = authRef.current?.currentUser?.uid || crypto.randomUUID();
                        setIsDbReady(true);
                        console.log("Firebase initialized successfully. User ID:", userIdRef.current);
                    } catch (error) {
                        console.error("Error initializing Firebase:", error);
                        displayStatus('حدث خطأ في الاتصال بالخدمة. يرجى المحاولة لاحقًا.', 'error');
                    }
                };

                initFirebase();
            }, [firebaseConfig, fetchAndIncrementOrderNumber]);

            // Effect to handle URL parameters for shared invoices
            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const invoiceId = urlParams.get('invoice');
                if (isDbReady && invoiceId) {
                    setSharedInvoiceId(invoiceId);
                    fetchInvoiceById(invoiceId);
                } else if (isDbReady && !invoiceId) {
                    fetchSalesData();
                    resetForm();
                }
            }, [isDbReady, fetchAndIncrementOrderNumber, resetForm]);

            const fetchInvoiceById = async (invoiceId) => {
                try {
                    const docRef = doc(dbRef.current, `/artifacts/${appId}/users/${userIdRef.current}/orders`, invoiceId);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const order = docSnap.data();
                        setBranchName(order.branchName);
                        setCashierName(order.cashierName);
                        setDeliveryName(order.deliveryName);
                        setCustomerName(order.customerName);
                        setCustomerPhone(order.customerPhone);
                        setOrderNumber(order.orderNumber);
                        setOrderDate(order.orderDate.slice(0, 16));
                        setItems(order.items.map((item, index) => ({ ...item, id: index + 1 })));
                        setTotal(order.total);
                        setIsOrderSaved(true);
                    } else {
                        displayStatus('لم يتم العثور على الفاتورة.', 'error');
                        setSharedInvoiceId(null);
                    }
                } catch (error) {
                    console.error("Error fetching invoice:", error);
                    displayStatus('حدث خطأ في جلب الفاتورة.', 'error');
                    setSharedInvoiceId(null);
                }
            };

            const fetchSalesData = async () => {
                if (!isDbReady || !userIdRef.current) return;

                try {
                    const ordersCollectionRef = collection(dbRef.current, `/artifacts/${appId}/users/${userIdRef.current}/orders`);
                    const q = query(ordersCollectionRef);
                    const querySnapshot = await getDocs(q);
                    
                    const fetchedData = [];
                    querySnapshot.forEach((doc) => {
                        fetchedData.push({ id: doc.id, ...doc.data() });
                    });
                    setSalesData(fetchedData);
                } catch (error) {
                    console.error("Error fetching sales data:", error);
                    displayStatus('حدث خطأ أثناء تحميل بيانات المبيعات.', 'error');
                }
            };
            
            const calculateTotal = useCallback(() => {
                const newTotal = items.reduce((sum, item) => {
                    const quantity = Number(item.quantity) || 0;
                    const price = Number(item.price) || 0;
                    return sum + (quantity * price);
                }, 0);
                setTotal(newTotal);
            }, [items]);

            const handleItemChange = (id, field, value) => {
                const updatedItems = items.map(item =>
                    item.id === id ? { ...item, [field]: value } : item
                );
                setItems(updatedItems);
            };

            useEffect(() => {
                calculateTotal();
            }, [items, calculateTotal]);

            const handleAddItem = () => {
                setItems([...items, { id: Date.now(), name: '', quantity: 1, price: '' }]);
            };
            
            const handleSaveOrder = async () => {
                if (!branchName || !cashierName || !deliveryName || !orderDate || !orderNumber || !customerName || !customerPhone) {
                    displayStatus('يرجى ملء جميع حقول البيانات الأساسية أولاً.', 'error');
                    return;
                }

                const orderItems = items.filter(item => item.name);
                if (orderItems.length === 0) {
                    displayStatus('يرجى إضافة صنف واحد على الأقل.', 'error');
                    return;
                }

                const orderData = {
                    branchName,
                    cashierName,
                    deliveryName,
                    customerName,
                    customerPhone,
                    orderNumber: orderNumber,
                    orderDate: new Date(orderDate).toISOString(),
                    items: orderItems.map(item => ({
                        ...item,
                        quantity: Number(item.quantity) || 0,
                        price: Number(item.price) || 0
                    })),
                    total,
                    savedAt: new Date().toISOString(),
                    userId: userIdRef.current
                };

                try {
                    if (!isDbReady) {
                        displayStatus('جارٍ الاتصال بالخدمة. يرجى المحاولة مرة أخرى.', 'error');
                        return;
                    }
                    const docRef = await addDoc(collection(dbRef.current, `/artifacts/${appId}/users/${userIdRef.current}/orders`), orderData);
                    console.log("Document written with ID: ", docRef.id);
                    displayStatus('تم حفظ الطلب بنجاح!', 'success');
                    setIsOrderSaved(true);
                    fetchSalesData();
                } catch (e) {
                    console.error("Error adding document: ", e);
                    displayStatus('حدث خطأ في الحفظ. يرجى المحاولة مرة أخرى.', 'error');
                }
            };
            
            const handleSelectOrder = (order) => {
                setBranchName(order.branchName);
                setCashierName(order.cashierName);
                setDeliveryName(order.deliveryName);
                setCustomerName(order.customerName);
                setCustomerPhone(order.customerPhone);
                setOrderNumber(order.orderNumber);
                setOrderDate(order.orderDate.slice(0, 16));
                setItems(order.items.map((item, index) => ({ ...item, id: index + 1 })));
                setTotal(order.total);
                setIsOrderSaved(true);
                setShowSavedOrders(false);
            };

            const handlePrintInvoice = () => {
                // If a shared invoice is being viewed, prevent printing
                if (sharedInvoiceId) {
                    displayStatus('لا يمكن طباعة فاتورة تمت مشاركتها.', 'error');
                    return;
                }

                if (!isOrderSaved) {
                    displayStatus('يجب حفظ الطلب أولاً قبل الطباعة.', 'error');
                    return;
                }

                // Construct the HTML for printing directly from state variables for robustness
                const invoiceContent = `
                    <div class="invoice-print-container">
                        <div class="invoice-header">
                            <h2>حلواني لابوم</h2>
                            <p>ت 01200016131</p>
                        </div>
                        <div class="invoice-details">
                            <p><strong>التاريخ:</strong> ${new Date(orderDate).toLocaleString('ar-EG', { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                            <p><strong>رقم الطلب:</strong> ${orderNumber}</p>
                            <p><strong>الفرع:</strong> ${branchName}</p>
                            <p><strong>الكاشير:</strong> ${cashierName}</p>
                            <p><strong>الطيار:</strong> ${deliveryName}</p>
                            <p><strong>العميل:</strong> ${customerName}</p>
                            <p><strong>التليفون:</strong> ${customerPhone}</p>
                        </div>
                        <table class="invoice-items">
                            <thead>
                                <tr>
                                    <th style="text-align: right;">الصنف</th>
                                    <th style="text-align: right;">السعر</th>
                                    <th style="text-align: center;">الكمية</th>
                                    <th style="text-align: right;">الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.filter(item => item.name).map((item, index) => `
                                    <tr key=${index}>
                                        <td>${item.name}</td>
                                        <td style="text-align: right;">${Number(item.price).toFixed(2)} ج.م</td>
                                        <td style="text-align: center;">${item.quantity}</td>
                                        <td style="text-align: right;">${(Number(item.quantity) * Number(item.price)).toFixed(2)} ج.م</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="invoice-totals">
                            <div><span>الإجمالي الكلي:</span> <span>${total.toFixed(2)} ج.م</span></div>
                        </div>
                        <div class="invoice-footer">
                            <p>شكرًا لك على ثقتك بنا!</p>
                            <p>تفضل بزيارتنا مرة أخرى.</p>
                        </div>
                    </div>
                `;

                const printWindow = window.open('', '', 'height=600,width=800');
                printWindow.document.write('<html><head><title>Print Invoice</title>');
                printWindow.document.write('<style>');
                printWindow.document.write('body { font-family: \'Almarai\', sans-serif; direction: rtl; margin: 0; padding: 20px; color: #000; }');
                printWindow.document.write('.invoice-print-container { width: 100%; max-width: 400px; margin: 0 auto; padding: 10px; }');
                printWindow.document.write('.invoice-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 15px; margin-bottom: 15px; }');
                printWindow.document.write('.invoice-header h2 { margin: 0; font-size: 1.5em; font-family: \'Changa\', sans-serif; }');
                printWindow.document.write('.invoice-header p { margin: 0; font-size: 1em; font-weight: bold; }');
                printWindow.document.write('.invoice-details p { margin: 3px 0; font-weight: bold; }');
                printWindow.document.write('.invoice-details { border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }');
                printWindow.document.write('.invoice-items { width: 100%; border-collapse: collapse; margin-bottom: 10px; }');
                printWindow.document.write('.invoice-items th, .invoice-items td { padding: 8px; text-align: right; font-weight: bold; }');
                printWindow.document.write('.invoice-items th { border-bottom: 1px solid #000; }');
                printWindow.document.write('.invoice-totals { text-align: right; border-top: 2px dashed #000; padding-top: 10px; }');
                printWindow.document.write('.invoice-totals div { display: flex; justify-content: space-between; margin-bottom: 3px; font-weight: bold; }');
                printWindow.document.write('.invoice-footer { text-align: center; margin-top: 15px; font-size: 0.8em; }');
                printWindow.document.write('@media print { .no-print { display: none; } }');
                printWindow.document.write('</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write(invoiceContent);
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.print();
            };

            const handleShareInvoice = async () => {
                if (!isOrderSaved) {
                    displayStatus('يجب حفظ الطلب أولاً قبل المشاركة.', 'error');
                    return;
                }
                const orderToShare = salesData.find(order => order.orderNumber === orderNumber);
                if (!orderToShare) {
                    displayStatus('خطأ: لم يتم العثور على الطلب المحفوظ.', 'error');
                    return;
                }
                
                const shareableUrl = `${window.location.origin}${window.location.pathname}?invoice=${orderToShare.id}`;
                
                try {
                    await navigator.clipboard.writeText(shareableUrl);
                    displayStatus('تم نسخ الرابط إلى الحافظة!', 'success');
                } catch (err) {
                    // Fallback for environments where Clipboard API is not available
                    const textarea = document.createElement('textarea');
                    textarea.value = shareableUrl;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    displayStatus('تم نسخ الرابط إلى الحافظة (طريقة احتياطية).', 'success');
                }
            };
            
            const totalRevenue = salesData.reduce((sum, order) => sum + order.total, 0);
            const totalOrders = salesData.length;

            const getDailySales = () => {
                const dailySales = salesData.reduce((acc, order) => {
                    const date = new Date(order.orderDate).toLocaleDateString('en-CA');
                    acc[date] = (acc[date] || 0) + order.total;
                    return acc;
                }, {});
                
                const sortedDates = Object.keys(dailySales).sort();
                const chartData = sortedDates.map(date => ({
                    date,
                    revenue: dailySales[date]
                }));
                
                const maxRevenue = Math.max(...chartData.map(d => d.revenue), 0) * 1.1;
                
                return { chartData, maxRevenue };
            };

            const { chartData, maxRevenue } = getDailySales();

            const renderChart = () => {
                if (chartData.length === 0) {
                    return <div className="text-center text-gray-500 py-4">لا توجد بيانات متاحة لعرض الرسم البياني.</div>;
                }

                const width = 300;
                const height = 150;
                const margin = 10;
                const barWidth = (width - 2 * margin) / chartData.length;

                return (
                    <svg width={width} height={height}>
                        {[...Array(5)].map((_, i) => (
                            <line key={i} x1={margin} y1={height - margin - (i / 4) * (height - 2 * margin)} x2={width - margin} y2={height - margin - (i / 4) * (height - 2 * margin)} stroke="#e5e7eb" strokeDasharray="3 3" />
                        ))}
                        {chartData.map((d, i) => (
                            <rect
                                key={i}
                                x={margin + i * barWidth}
                                y={height - margin - (d.revenue / maxRevenue) * (height - 2 * margin)}
                                width={barWidth - 2}
                                height={(d.revenue / maxRevenue) * (height - 2 * margin)}
                                fill="#e53835"
                                rx="2"
                            />
                        ))}
                    </svg>
                );
            };

            const renderInvoiceView = () => {
                return (
                    <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm" id="invoice-to-print">
                        <div className="invoice-print-container">
                            <div className="invoice-header">
                                <h2 className="font-['Changa']">حلواني لابوم</h2>
                                <p>ت 01200016131</p>
                            </div>
                            <div className="invoice-details">
                                <p><strong>التاريخ:</strong> {new Date(orderDate).toLocaleString('ar-EG', { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                                <p><strong>رقم الطلب:</strong> {orderNumber}</p>
                                <p><strong>الفرع:</strong> {branchName}</p>
                                <p><strong>الكاشير:</strong> {cashierName}</p>
                                <p><strong>الطيار:</strong> {deliveryName}</p>
                                <p><strong>العميل:</strong> {customerName}</p>
                                <p><strong>التليفون:</strong> {customerPhone}</p>
                            </div>
                            <table className="invoice-items">
                                <thead>
                                    <tr>
                                        <th style="text-align: right;">الصنف</th>
                                        <th style="text-align: right;">السعر</th>
                                        <th style="text-align: center;">الكمية</th>
                                        <th style="text-align: right;">الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {items.filter(item => item.name).map((item, index) => (
                                        <tr key={index}>
                                            <td>{item.name}</td>
                                            <td style="text-align: right;">{Number(item.price).toFixed(2)} ج.م</td>
                                            <td style="text-align: center;">{item.quantity}</td>
                                            <td style="text-align: right;">{(Number(item.quantity) * Number(item.price)).toFixed(2)} ج.م</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            <div className="invoice-totals">
                                <div><span>الإجمالي الكلي:</span> <span>{total.toFixed(2)} ج.م</span></div>
                            </div>
                            <div className="invoice-footer">
                                <p>شكرًا لك على ثقتك بنا!</p>
                                <p>تفضل بزيارتنا مرة أخرى.</p>
                            </div>
                        </div>
                        <div class="flex justify-center mt-4">
                            <button onClick={() => window.location.href = window.location.origin + window.location.pathname} className="bg-red-600 text-white text-sm px-4 py-2 rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 font-['Almarai']">
                                إنشاء فاتورة جديدة
                            </button>
                        </div>
                    </div>
                );
            };

            const renderMainApp = () => {
                if (currentPage === 'dashboard') {
                    return (
                        <div className="space-y-6">
                            <h2 className="text-2xl font-bold text-red-700 text-center font-['Almarai']">لوحة التحكم</h2>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-white p-4 rounded-xl shadow-md text-center">
                                    <p className="text-xl md:text-2xl font-bold text-red-600">{totalOrders}</p>
                                    <p className="text-sm text-gray-500 font-['Almarai']">إجمالي الطلبات</p>
                                </div>
                                <div className="bg-white p-4 rounded-xl shadow-md text-center">
                                    <p className="text-xl md:text-2xl font-bold text-red-600">{totalRevenue.toFixed(2)} ج.م</p>
                                    <p className="text-sm text-gray-500 font-['Almarai']">إجمالي الإيرادات</p>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-md">
                                <h3 className="text-lg font-bold text-gray-700 mb-4 font-['Almarai']">المبيعات اليومية</h3>
                                <div className="flex justify-center items-end">
                                    {renderChart()}
                                </div>
                                <p className="text-center text-xs text-gray-400 mt-2 font-['Almarai']">تواريخ المبيعات</p>
                            </div>
                        </div>
                    );
                } else {
                    return (
                        <div className="space-y-4">
                            <div className="text-center mb-6">
                                <h1 className="text-2xl md:text-3xl font-extrabold text-red-700 font-['Changa']">إدارة طلبات الدليفري</h1>
                            </div>

                            <div className="space-y-4">
                                <div className="flex flex-col">
                                    <label className="text-sm font-semibold text-gray-700 w-full text-right mb-1">اسم الفرع</label>
                                    <input
                                        type="text"
                                        value={branchName}
                                        onChange={(e) => setBranchName(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-400 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors duration-200"
                                        placeholder="أدخل اسم الفرع"
                                        dir="rtl"
                                    />
                                </div>
                                <div className="flex flex-col">
                                    <label className="text-sm font-semibold text-gray-700 w-full text-right mb-1">اسم الكاشير</label>
                                    <input
                                        type="text"
                                        value={cashierName}
                                        onChange={(e) => setCashierName(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-400 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors duration-200"
                                        placeholder="أدخل اسم الكاشير"
                                        dir="rtl"
                                    />
                                </div>
                                <div className="flex flex-col">
                                    <label className="text-sm font-semibold text-gray-700 w-full text-right mb-1">اسم الطيار</label>
                                    <input
                                        type="text"
                                        value={deliveryName}
                                        onChange={(e) => setDeliveryName(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-400 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors duration-200"
                                        placeholder="أدخل اسم الطيار"
                                        dir="rtl"
                                    />
                                </div>
                                <div className="flex flex-col">
                                    <label className="text-sm font-semibold text-gray-700 w-full text-right mb-1">رقم الطلب</label>
                                    {isLoadingOrderNumber ? (
                                        <div className="w-full px-4 py-2 text-gray-500 border border-gray-400 rounded-lg shadow-inner text-right animate-pulse">
                                            جاري التحميل...
                                        </div>
                                    ) : (
                                        <input
                                            type="text"
                                            value={orderNumber}
                                            className="w-full px-4 py-2 border border-gray-400 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors duration-200"
                                            placeholder="أدخل رقم الطلب"
                                            readOnly
                                            dir="rtl"
                                        />
                                    )}
                                </div>
                                <div className="flex flex-col">
                                    <label className="text-sm font-semibold text-gray-700 w-full text-right mb-1">اسم العميل</label>
                                    <input
                                        type="text"
                                        value={customerName}
                                        onChange={(e) => setCustomerName(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-400 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors duration-200"
                                        placeholder="أدخل اسم العميل"
                                        dir="rtl"
                                    />
                                </div>
                                <div className="flex flex-col">
                                    <label className="text-sm font-semibold text-gray-700 w-full text-right mb-1">تليفون العميل</label>
                                    <input
                                        type="tel"
                                        value={customerPhone}
                                        onChange={(e) => setCustomerPhone(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-400 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors duration-200"
                                        placeholder="أدخل رقم تليفون العميل"
                                        dir="rtl"
                                    />
                                </div>
                                <div className="flex flex-col">
                                    <label className="text-sm font-semibold text-gray-700 w-full text-right mb-1">التاريخ والوقت</label>
                                    <input
                                        type="datetime-local"
                                        value={orderDate}
                                        onChange={(e) => setOrderDate(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-400 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors duration-200"
                                        dir="rtl"
                                    />
                                </div>
                            </div>

                            <div className="mt-6 border border-gray-200 rounded-lg overflow-hidden">
                                <table className="w-full text-right text-sm">
                                    <thead className="bg-red-600 text-white">
                                        <tr>
                                            <th className="p-2 font-['Almarai']">الصنف</th>
                                            <th className="p-2 font-['Almarai']">السعر</th>
                                            <th className="p-2 font-['Almarai']">الكمية</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {items.map((item, index) => (
                                            <tr key={item.id} className="border-b border-gray-200 last:border-b-0">
                                                <td className="p-2 relative">
                                                    <input
                                                        type="text"
                                                        value={item.name}
                                                        onChange={(e) => handleItemChange(item.id, 'name', e.target.value)}
                                                        className="w-full text-right bg-transparent border-none focus:outline-none"
                                                        placeholder="اسم الصنف"
                                                        dir="rtl"
                                                    />
                                                </td>
                                                <td className="p-2">
                                                    <input
                                                        type="number"
                                                        value={item.price}
                                                        onChange={(e) => handleItemChange(item.id, 'price', e.target.value)}
                                                        className="w-full text-right bg-transparent border-none focus:outline-none"
                                                        placeholder="السعر"
                                                        dir="rtl"
                                                    />
                                                </td>
                                                <td className="p-2">
                                                    <input
                                                        type="number"
                                                        value={item.quantity}
                                                        onChange={(e) => handleItemChange(item.id, 'quantity', e.target.value)}
                                                        className="w-full text-center bg-transparent border-none focus:outline-none"
                                                        min="1"
                                                        dir="rtl"
                                                    />
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            <div className="flex justify-between mt-4">
                                <button onClick={handleAddItem} className="bg-red-600 text-white text-sm px-4 py-2 rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 font-['Almarai']">
                                    أضف صنف جديد
                                </button>
                                <button onClick={resetForm} className="bg-red-600 text-white text-sm px-4 py-2 rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 font-['Almarai']">
                                    طلب جديد
                                </button>
                            </div>

                            <div className="mt-6 pt-4 border-t-2 border-dashed border-gray-300">
                                <div className="flex justify-between text-lg font-bold text-gray-800">
                                    <span className="font-['Almarai']">الإجمالي الكلي:</span>
                                    <span>{total.toFixed(2)} ج.م</span>
                                </div>
                            </div>

                            <div className="flex justify-end gap-3 mt-6">
                                <button onClick={() => setShowSavedOrders(true)} className="flex-1 bg-blue-600 text-white py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 font-['Almarai']">
                                    الطلبات المحفوظة
                                </button>
                                <button onClick={handleSaveOrder} className="flex-1 bg-red-950 text-white py-3 rounded-lg shadow-md hover:bg-black transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-900 font-['Almarai']">
                                    حفظ الطلب
                                </button>
                                <button onClick={handlePrintInvoice} className="flex-1 bg-red-600 text-white py-3 rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 font-['Almarai']">
                                    طباعة الفاتورة
                                </button>
                            </div>
                            <div className="flex justify-center mt-4">
                                <button onClick={handleShareInvoice} className="w-full bg-yellow-500 text-gray-800 py-3 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 font-['Almarai']">
                                    مشاركة الفاتورة (نسخ الرابط)
                                </button>
                            </div>
                            {statusMessage.message && (
                                <div className={`mt-4 text-center py-2 px-4 rounded-lg font-bold font-['Almarai'] ${statusMessage.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {statusMessage.message}
                                </div>
                            )}
                            
                            {showSavedOrders && (
                                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                                    <div className="bg-zinc-100 p-6 rounded-2xl shadow-xl w-full max-w-md max-h-[80vh] overflow-y-auto">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="text-xl font-bold text-red-700 font-['Almarai']">الطلبات المحفوظة</h3>
                                            <button onClick={() => setShowSavedOrders(false)} className="text-gray-500 hover:text-gray-700 transition-colors duration-200">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                        {salesData.length === 0 ? (
                                            <p className="text-center text-gray-500 font-['Almarai']">لا توجد طلبات محفوظة حتى الآن.</p>
                                        ) : (
                                            <div className="space-y-4">
                                                {salesData.map((order, index) => (
                                                    <div
                                                        key={index}
                                                        onClick={() => handleSelectOrder(order)}
                                                        className="bg-white p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-200 transition-colors duration-200"
                                                        dir="rtl"
                                                    >
                                                        <p className="font-bold text-gray-800 font-['Almarai']">رقم الطلب: {order.orderNumber}</p>
                                                        <p className="text-sm text-gray-600 font-['Almarai']">العميل: {order.customerName}</p>
                                                        <p className="text-sm text-gray-600 font-['Almarai']">الإجمالي: {order.total.toFixed(2)} ج.م</p>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-red-600 py-10 font-['Almarai'] antialiased" dir="rtl">
                    <div className="w-full max-w-sm bg-zinc-100 rounded-2xl shadow-xl p-6 md:p-8 transform transition-transform duration-300 hover:scale-[1.01] border border-gray-200">
                        <div className="text-center bg-red-800 text-white p-2 mb-6 rounded-lg font-extrabold text-lg shadow-inner font-['Almarai']">
                            برمجة وتصميم مهندس / وائل السيد
                        </div>
                        
                        {sharedInvoiceId ? (
                            renderInvoiceView()
                        ) : (
                            <>
                                <div className="flex justify-center gap-4 mb-6">
                                    <button
                                        onClick={() => setCurrentPage('invoice')}
                                        className={`py-2 px-4 rounded-full font-bold transition-colors duration-200 font-['Almarai'] ${currentPage === 'invoice' ? 'bg-red-700 text-white shadow-md' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`}
                                    >
                                        الفواتير
                                    </button>
                                    <button
                                        onClick={() => setCurrentPage('dashboard')}
                                        className={`py-2 px-4 rounded-full font-bold transition-colors duration-200 font-['Almarai'] ${currentPage === 'dashboard' ? 'bg-red-700 text-white shadow-md' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`}
                                    >
                                        لوحة التحكم
                                    </button>
                                </div>
                                {renderMainApp()}
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
